---
title: "transformersã§ã®ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’çŠ¶æ³ã‚’Slackã«é€šçŸ¥ã™ã‚‹"
emoji: "ğŸ¤—"
type: "tech"
topics: ["transformers", "slack", "python"]
published: true
---
ã©ã†ã‚‚ã€SpiralAIã®[@ksterx](https://twitter.com/kster_xyz)ã§ã™ã€‚

ã¿ãªã•ã‚“ã¯ã€ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚’è¡Œã†æ™‚ã€ãªã‚“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦å­¦ç¿’ã—ã¦ã„ã¾ã™ã§ã—ã‚‡ã†ã‹ï¼Ÿè‡ªåˆ†è‡ªèº«ã¯ã€ãªã‚“ã ã‹ã‚“ã pytorch lightningã‚’ä½¿ã£ã¦ã„ã‚‹æ™‚æœŸãŒé•·ã‹ã£ãŸã®ã‹ãªã¨æ€ã„ã¾ã™ãŒã€æœ€è¿‘ã¯è¨€èªç³»ã‚’è§¦ã£ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ğŸ¤—transformersã‚’ä½¿ç”¨ã™ã‚‹æ©Ÿä¼šãŒå¤šã„ã§ã™ã€‚ï¼ˆmegatronã‚„llama-factoryã«æµ®æ°—ã—ãŸã„æ°—ã‚‚ã—ã¦ã„ã¾ã™ãŒã€ã€ã€ï¼‰

ğŸ¤—Hugging Face Hubã«ã‚ã‚‹å¤šãã®ãƒ¢ãƒ‡ãƒ«ãŒã€ğŸ¤—transformersã‚’ä½¿ç”¨ã—ã¦ãƒ­ãƒ¼ãƒ‰ã€æ¨è«–ãŒç°¡å˜ã«è¡Œãˆã¾ã™ã€‚ã¾ãŸã€ğŸ¤—transformersã¯æ¯”è¼ƒçš„æ–°ã—ã„è«–æ–‡ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã‚ã£ã¦ã‚‚Trainerã¨ã—ã¦æä¾›ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ãŸã‚ã€ç°¡å˜ã«å¤šæ§˜ãªã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’è©¦ã›ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚

å®Ÿéš›ã«ğŸ¤—transformersã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’ã‚’ã™ã‚‹å ´åˆã€å­¦ç¿’çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ã“ã®è¾ºã¯ã€`TrainingArguments`ã‚„ãã®ãƒ©ãƒƒãƒ‘ãƒ¼`SFTConfig`ç­‰ã®`report_to`ã«ãŠå¥½ã¿ã®å‡ºåŠ›å…ˆï¼ˆwandbã‚„tensorboardã€ã‚ã‚‹ã„ã¯ä½•ã‚‚è¨­å®šã—ãªã„ã¨ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å…¨éƒ¨ã«ï¼ï¼‰ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆtrain/eval lossã‚„ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³ç­‰ï¼‰ã®ãƒ­ã‚®ãƒ³ã‚°ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚

![report_to](https://storage.googleapis.com/zenn-user-upload/585894bcd724-20240710.png)*Source: Hugging Face Documentation*

```python
from trl import SFTConfig, SFTTrainer

train_args = SFTConfig(
    report_to="wandb",
    # ...
)
...
trainer = SFTTrainer(
    args=train_args,
    # ...
)
```

ãŸã ã€æˆ‘ã€…ã®ã‚ˆã†ãªå¿ƒé…æ€§andé¢å€’ãã•ãŒã‚Šãªäººé–“ã¯ã€å­¦ç¿’ãŒé€²ã‚“ã§ã„ã‚‹ã®ã‹ãŒå¿ƒé…ã«ãªã‚‹ã‚ã‘ã§ã™ã€‚ã‚ã–ã‚ã–ã€wandbã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¦‹ã‚‹å¿…è¦ã‚‚ãªã„ã€ãã‚Œã§ã‚‚ã€ã©ã®ãã‚‰ã„é€²ã‚“ã§ã„ã‚‹ã‹ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãã‚‰ã„ã§çŸ¥ã‚Œã‚Œã°è‰¯ã„â€•â€•â€•**slack**ã«é€šçŸ¥ã™ã‚Œã°è‰¯ãã­ã€‚

# æœ¬é¡Œ
å‰ç½®ããŒé•·ããªã‚Šã¾ã—ãŸã€‚ä»Šå›å®Ÿç¾ã™ã‚‹ã®ã¯ã€ã‚¨ãƒãƒƒã‚¯ãŒçµ‚äº†ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è‡ªä½“ãŒçµ‚äº†ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«é€šçŸ¥ã‚’é£›ã°ã™ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

## ã§ãã‚‹ã‚‚ã®
![](https://storage.googleapis.com/zenn-user-upload/355037e0a89c-20240711.png)
*â†‘â†‘â†‘â†‘ã“ã‚“ãªæ„Ÿã˜*

## å¿…è¦ãªã‚‚ã®
- Slackã®Token ([å‚è€ƒãƒšãƒ¼ã‚¸](https://qiita.com/seratch/items/93714b5cf3974c2f5327))
    - ç’°å¢ƒå¤‰æ•°`SLACK_BOT_TOKEN`ã¨ã—ã¦è¨­å®š
- Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒª
    - `transformers`
    - `slack_sdk`

## å®Ÿè£…
ğŸ¤—transformersã®ãƒ¢ãƒ‡ãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ™‚ã®æŒ™å‹•ã‚’å¤‰ãˆã‚‹æ–¹æ³•ã®ä¸€ã¤ãŒã€`TrainerCallback`ã‚’ç¶™æ‰¿ã—ãŸç‹¬è‡ªã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã™ã€‚ç‹¬è‡ªã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ãƒ©ã‚¹ã«ã€ã‚¹ãƒ†ãƒƒãƒ—ã™ã‚‹å‰/å¾Œã€ã‚¨ãƒãƒƒã‚¯ãŒçµ‚ã‚ã£ãŸæ™‚ã€ä¿å­˜ã‚’è¡Œã†æ™‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã“ã¨ã§å®Ÿç¾ã•ã‚Œã¾ã™ã€‚ï¼ˆ[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://huggingface.co/docs/transformers/v4.42.0/ja/main_classes/callback#transformers.TrainerCallback))
ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ãŸãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ã€è‡ªåˆ†ã§æ¸¡ã—ãŸå­¦ç¿’æ¡ä»¶`TrainingArguments`ã‚„å­¦ç¿’ã®ç¾åœ¨ã®çŠ¶æ…‹`TrainerState`ç­‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚ä»Šå›ã§è¨€ãˆã°ç¾åœ¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã‚„ä¿å­˜å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦Slackã®ãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒã‚¹ãƒˆã—ã¾ã™ã€‚

```python
from transformers import TrainerCallback, TrainingArguments, TrainerState, TrainerControl

class SlackCallback(TrainerCallback):
    default_text = "\n\nProject: {proj}\nRepo: {repo}\nLog: {log_dir}\n\n"

    def __init__(self, channel, client=None):
        super().__init__()
        self.client = (
            WebClient(token=os.environ["SLACK_BOT_TOKEN"]) if client is None else client
        )
        self.channel = channel

    def on_epoch_end(
        self,
        args: TrainingArguments,
        state: TrainerState,
        control: TrainerControl,
        **kwargs,
    ):
        if state.is_world_process_zero:
            self.client.chat_postMessage(
                channel=self.channel,
                text=f"âœ…Epoch {state.epoch:.1f} (global step {state.global_step}) finished!!âœ…"
                + self.default_text.format(
                    proj=args.run_name,
                    repo=args.hub_model_id,
                    log_dir=args.output_dir,
                ),
            )

    def on_train_begin(
        self,
        args: TrainingArguments,
        state: TrainerState,
        control: TrainerControl,
        **kwargs,
    ):
        if state.is_world_process_zero:
            self.client.chat_postMessage(
                channel=self.channel,
                text="ğŸš€Training startedğŸš€"
                + self.default_text.format(
                    proj=args.run_name,
                    repo=args.hub_model_id,
                    log_dir=args.output_dir,
                ),
            )

    def on_train_end(
        self,
        args: TrainingArguments,
        state: TrainerState,
        control: TrainerControl,
        **kwargs,
    ):
        if state.is_world_process_zero:
            self.client.chat_postMessage(
                channel=self.channel,
                text="ğŸ‰Training finishedğŸ‰"
                + self.default_text.format(
                    proj=args.run_name,
                    repo=args.hub_model_id,
                    log_dir=args.output_dir,
                ),
            )
```


## ä½¿ã„æ–¹

`SlackCallback`ã‚¯ãƒ©ã‚¹ã‚’Trainerã«æ¸¡ã™ã“ã¨ã§å‹•ãã¾ã™ã€‚
```python
slack_callback = SlackCallback("writeæ¨©é™ã®ã‚ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«å")
trainer = SFTTrainer(
    ...,
    callbacks=[slack_callback]
)
trainer.train()
```

ã“ã‚Œã§ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å‹•ã‹ã™ã¨â€¦
![](https://storage.googleapis.com/zenn-user-upload/c375a6006b68-20240711.png)
**ğŸ‰ç„¡äº‹Slackã®ä»»æ„ã®ãƒãƒ£ãƒ³ãƒãƒ«ã«é€šçŸ¥ã™ã‚‹ã“ã¨ãŒã§ãã‚‹æ§˜ã«ãªã‚Šã¾ã—ãŸğŸ‰**

# ã¾ã¨ã‚
ä»Šå›ã¯ã€ğŸ¤—transformersã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ‡ãƒ«ã®å­¦ç¿’é€²æ—ã‚’Slackã«é€šçŸ¥ã™ã‚‹æ–¹æ³•ã‚’ã”ç´¹ä»‹ã—ã¾ã—ãŸã€‚ã“ã‚Œã§ã€å­¦ç¿’ã®é€²æ—çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æŠŠæ¡ã™ã‚‹ã®ãŒæ¥½ã«ãªã‚Šã¾ã™ã­ã€‚ã‚ã–ã‚ã–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã«è¡Œã‹ãªãã¦ã‚‚ã€é€šçŸ¥ãŒæ¥ã‚‹ã®ã§å®‰å¿ƒã—ã¦å­¦ç¿’ã‚’é€²ã‚ã‚‰ã‚Œã¾ã™ã€‚

Slacké€šçŸ¥ã¯ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ã¨ã‚‚å…±æœ‰ã—ã‚„ã™ãã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®é€æ˜æ€§ã‚’é«˜ã‚ã‚‹åŠ¹æœã‚‚æœŸå¾…ã§ãã¾ã™ã€‚ã‚‚ã¡ã‚ã‚“ã€ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã‚’ã•ã‚‰ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã€ç‰¹å®šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚„ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚çš†ã•ã‚“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦ã€æœ€é©ãªé€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

### LLMã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’å‹Ÿé›†ã—ã¦ã„ã¾ã™ï¼ï¼
[SpiralAI](go-spiral.ai)ã§ã¯ã€ç”ŸæˆAIÃ—ã‚¨ãƒ³ã‚¿ãƒ¡ã‚’ãƒ†ãƒ¼ãƒã«æ§˜ã€…ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ã¾ã™ï¼ã‚‚ã—ã€ã”èˆˆå‘³ãŒã‚ã‚Œã°[@ksterx](https://twitter.com/kster_xyz)ã‚„[æ¡ç”¨ãƒšãƒ¼ã‚¸](https://go-spiral.ai/recruit)ã¾ã§ã”é€£çµ¡ãã ã•ã„ã€œ
